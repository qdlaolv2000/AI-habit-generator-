<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¾®ä¹ æƒ¯å·¥å…·ç®± - åŸºäºç¦æ ¼è¡Œä¸ºè®¾è®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        .page {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin: 20px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 25px;
            font-size: 0.9em;
        }

        .tip-box {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .tip-box h3 {
            color: #2b6cb0;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #4299e1;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
            min-width: 150px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
            display: inline-block;
        }

        .behavior-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .behavior-item:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
        }

        .behavior-item.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .behavior-header {
            margin-bottom: 8px;
        }

        .behavior-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .behavior-text {
            margin-bottom: 10px;
            font-weight: 500;
        }

        .behavior-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .checkbox-btn {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-btn.selected {
            background: #48bb78;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .final-recipe {
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        .final-recipe h3 {
            color: #2f855a;
            margin-bottom: 15px;
        }

        .recipe-formula {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
            border-left: 4px solid #48bb78;
        }

        .count-indicator {
            background: #4299e1;
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }

        .example-list {
            background: #fffaf0;
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .example-list ul {
            margin-left: 20px;
        }

        .example-list li {
            margin-bottom: 5px;
            color: #92400e;
        }

        .anchor-option,
        .celebration-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .anchor-option:hover,
        .celebration-option:hover {
            border-color: #4299e1;
        }

        .anchor-option.selected,
        .celebration-option.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .options-container {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 20px;
            padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid #4299e1;
            z-index: 1000;
            display: none;
        }

        .floating-controls.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .floating-count {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .floating-progress {
            width: 200px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .floating-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        .floating-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .floating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .floating-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }

            .page {
                margin: 10px 5px;
                padding: 20px;
                padding-bottom: 120px;
                /* ä¸ºæµ®åŠ¨æ§ä»¶ç•™å‡ºç©ºé—´ */
            }

            h1 {
                font-size: 1.5em;
            }

            h2 {
                font-size: 1.2em;
            }

            .navigation {
                flex-direction: column;
                gap: 10px;
            }

            .behavior-buttons {
                flex-direction: column;
            }

            .checkbox-btn {
                width: 100%;
            }

            .floating-controls {
                left: 10px;
                right: 10px;
                bottom: 10px;
            }

            .floating-progress {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ç¬¬ä¸€é¡µï¼šæ¬¢è¿é¡µé¢å’Œæ„¿æœ›è¾“å…¥ -->
        <div class="page active" id="page-1">
            <h1>ğŸŒŸ AIå¾®ä¹ æƒ¯å·¥å…·ç®±</h1>
            <div class="subtitle">åŸºäºç¦æ ¼è¡Œä¸ºè®¾è®¡æ¨¡å‹ - ç§‘å­¦å…»æˆå¥½ä¹ æƒ¯</div>

            <div class="tip-box">
                <h3>ğŸ’¡ ä»€ä¹ˆæ˜¯æœ‰æ•ˆæ„¿æœ›ï¼Ÿ</h3>
                <p><strong>æœ‰æ•ˆæ„¿æœ›åº”è¯¥ï¼š</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>å…·ä½“æ˜ç¡®ï¼Œä¸è¦è¿‡äºæŠ½è±¡</li>
                    <li>æ˜¯ä½ çœŸæ­£æƒ³è¦çš„ï¼Œè€Œä¸æ˜¯ä½ è§‰å¾—"åº”è¯¥"è¦çš„</li>
                    <li>å¯ä»¥é€šè¿‡å…·ä½“è¡Œä¸ºæ¥å®ç°</li>
                    <li>å¯¹ä½ æœ‰æ„ä¹‰ï¼Œèƒ½æ¿€å‘ä½ çš„åŠ¨æœº</li>
                </ul>
            </div>

            <div class="example-list">
                <h3>âœ… æœ‰æ•ˆæ„¿æœ›ç¤ºä¾‹ï¼š</h3>
                <ul>
                    <li>æé«˜ç¡çœ è´¨é‡</li>
                    <li>å¢å¼ºèº«ä½“å¥åº·</li>
                    <li>æå‡å­¦ä¹ æ•ˆç‡</li>
                    <li>æ”¹å–„å®¶åº­å…³ç³»</li>
                    <li>å‡å°‘ç„¦è™‘æƒ…ç»ª</li>
                    <li>æé«˜å·¥ä½œä¸“æ³¨åŠ›</li>
                </ul>
            </div>

            <div class="input-group">
                <label for="wishInput">è¯·è¾“å…¥ä½ çš„æ„¿æœ›ï¼š</label>
                <textarea id="wishInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³æé«˜ç¡çœ è´¨é‡ï¼Œè®©è‡ªå·±æ¯å¤©éƒ½ç²¾åŠ›å……æ²›..." maxlength="200"></textarea>
                <small style="color: #718096;">å»ºè®®20-200å­—ï¼Œæè¿°ä½ çœŸæ­£æƒ³è¦å®ç°çš„æ„¿æœ›</small>
            </div>

            <button class="btn" onclick="startBehaviorGeneration()">
                å¼€å§‹ç”Ÿæˆè¡Œä¸ºæ–¹æ¡ˆ ğŸš€
            </button>
        </div>

        <!-- ç¬¬äºŒé¡µï¼šè¡Œä¸ºé€‰æ‹©é¡µé¢ -->
        <div class="page" id="page-2">
            <h2>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ä½ æ„¿æ„åšçš„è¡Œä¸º</h2>
            <div class="subtitle">AIæ ¹æ®ä½ çš„æ„¿æœ›ç”Ÿæˆäº†ä»¥ä¸‹è¡Œä¸ºå»ºè®®ï¼Œé€‰æ‹©ä½ æ„¿æ„å°è¯•çš„ï¼ˆè‡³å°‘é€‰æ‹©10ä¸ªï¼‰</div>

            <div class="tip-box">
                <h3>ğŸ’¡ é€‰æ‹©æ ‡å‡†</h3>
                <p>ä»¥ä¸‹æ¯ä¸ªè¡Œä¸ºéƒ½æ˜¯ä¸ºäº†å¸®åŠ©ä½ å®ç°"<strong><span id="currentWish"></span></strong>"è¿™ä¸ªæ„¿æœ›è€Œç²¾å¿ƒè®¾è®¡çš„ã€‚è¯·é€‰æ‹©é‚£äº›ä½ è§‰å¾—ï¼š</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>çœŸæ­£æƒ³è¦å°è¯•çš„è¡Œä¸º</li>
                    <li>è§‰å¾—å¯¹å®ç°æ„¿æœ›æœ‰å¸®åŠ©çš„è¡Œä¸º</li>
                    <li>ç¬¦åˆä½ ç”Ÿæ´»æ–¹å¼çš„è¡Œä¸º</li>
                </ul>
            </div>

            <div class="count-indicator">
                å·²é€‰æ‹©ï¼š<span id="willingCount">0</span> / 10ä¸ªï¼ˆæœ€å°‘ï¼‰
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill1" style="width: 0%"></div>
            </div>

            <div id="behaviorsContainer">
                <!-- è¡Œä¸ºé€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage(1)">è¿”å›ä¸Šä¸€æ­¥</button>
                <button class="btn btn-small" onclick="loadMoreBehaviors()">åŠ è½½æ›´å¤šé€‰é¡¹</button>
                <button class="btn" onclick="proceedToAbility()" id="proceedBtn1" disabled>
                    è¿›å…¥ä¸‹ä¸€æ­¥
                </button>
            </div>
        </div>

        <!-- ç¬¬ä¸‰é¡µï¼šèƒ½åŠ›ç­›é€‰é¡µé¢ -->
        <div class="page" id="page-3">
            <h2>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ä½ èƒ½åšåˆ°çš„è¡Œä¸º</h2>
            <div class="subtitle">ä»ä½ åˆšæ‰é€‰æ‹©çš„è¡Œä¸ºä¸­ï¼Œé€‰å‡ºä½ ç¡®å®æœ‰èƒ½åŠ›å®Œæˆçš„</div>

            <div class="tip-box">
                <h3>ğŸ’ª èƒ½åŠ›è¯„ä¼°ç»´åº¦ï¼š</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>æ—¶é—´ï¼š</strong>ä½ æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ—¶é—´ï¼Ÿ</li>
                    <li><strong>èµ„é‡‘ï¼š</strong>ä½ æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„é‡‘ï¼Ÿ</li>
                    <li><strong>ä½“åŠ›ï¼š</strong>ä½ æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä½“åŠ›ï¼Ÿ</li>
                    <li><strong>è„‘åŠ›ï¼š</strong>è¿™ä¸ªè¡Œä¸ºæ˜¯å¦éœ€è¦è®¸å¤šåˆ›æ„å’Œè„‘åŠ›ï¼Ÿ</li>
                    <li><strong>æ—¥ç¨‹ï¼š</strong>è¿™ä¸ªè¡Œä¸ºç¬¦åˆä½ ç°åœ¨çš„æ—¥ç¨‹å—ï¼Ÿ</li>
                </ul>
            </div>

            <div class="count-indicator">
                å·²é€‰æ‹©ï¼š<span id="ableCount">0</span> ä¸ªé»„é‡‘è¡Œä¸º
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill2" style="width: 0%"></div>
            </div>

            <div id="abilityContainer">
                <!-- èƒ½åŠ›ç­›é€‰é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage(2)">è¿”å›ä¸Šä¸€æ­¥</button>
                <button class="btn" onclick="proceedToRecipe()" id="proceedBtn2" disabled>
                    ç”Ÿæˆä¹ æƒ¯é…æ–¹
                </button>
            </div>
        </div>

        <!-- ç¬¬å››é¡µï¼šé…æ–¹ç”Ÿæˆé¡µé¢ -->
        <div class="page" id="page-4">
            <h2>ç¬¬ä¸‰æ­¥ï¼šä¸ºä½ çš„é»„é‡‘è¡Œä¸ºç”Ÿæˆä¹ æƒ¯é…æ–¹</h2>
            <div class="subtitle">æ ¹æ®ç¦æ ¼è¡Œä¸ºè®¾è®¡æ¨¡å‹ï¼Œä¸ºæ¯ä¸ªé»„é‡‘è¡Œä¸ºå®šåˆ¶ä¸“å±é…æ–¹</div>

            <div class="tip-box">
                <h3>ğŸ¯ å¾®ä¹ æƒ¯é…æ–¹å…¬å¼ï¼š</h3>
                <p><strong>åœ¨æˆ‘[é”šç‚¹]ä¹‹åï¼Œæˆ‘ä¼š[å¾®è¡Œä¸º]ï¼Œä¸ºäº†è®©å¤§è„‘ç‰¢è®°è¿™ä¸ªä¹ æƒ¯ï¼Œæˆ‘ä¼š[åº†ç¥]ã€‚</strong></p>
            </div>

            <div id="recipeContainer">
                <!-- é…æ–¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage(3)">è¿”å›ä¸Šä¸€æ­¥</button>
                <button class="btn" onclick="proceedToFinal()">
                    ç”Ÿæˆæœ€ç»ˆæ–¹æ¡ˆ
                </button>
            </div>
        </div>

        <!-- ç¬¬äº”é¡µï¼šæœ€ç»ˆç»“æœé¡µé¢ -->
        <div class="page" id="page-5">
            <h1>ğŸ‰ ä½ çš„å¾®ä¹ æƒ¯å…»æˆæ–¹æ¡ˆ</h1>
            <div class="subtitle">ä¸ºäº†å®ç°ï¼š<span id="finalWish"></span></div>

            <div class="tip-box">
                <h3>ğŸŒŸ ä½¿ç”¨è¯´æ˜ï¼š</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>æ¯å¤©æŒ‰ç…§é…æ–¹æ‰§è¡Œï¼Œä¸è¦ç»™è‡ªå·±å¤ªå¤§å‹åŠ›</li>
                    <li>å®Œæˆåç«‹å³åº†ç¥ï¼Œåˆ›é€ ç§¯ææƒ…ç»ª</li>
                    <li>å¦‚æœæŸå¤©æ²¡åšåˆ°ï¼Œä¸è¦è‡ªè´£ï¼Œç¬¬äºŒå¤©ç»§ç»­</li>
                    <li>ä¹ æƒ¯å…»æˆåï¼Œå¯ä»¥é€æ¸å¢åŠ éš¾åº¦</li>
                </ul>
            </div>

            <div id="finalRecipeContainer">
                <!-- æœ€ç»ˆé…æ–¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="navigation">
                <button class="btn btn-secondary" onclick="goToPage(4)">è¿”å›ä¿®æ”¹</button>
                <button class="btn" onclick="restartProcess()">
                    é‡æ–°å¼€å§‹
                </button>
            </div>
        </div>

        <!-- åŠ è½½é¡µé¢ -->
        <div class="page" id="loading-page">
            <div class="loading">
                <div class="spinner"></div>
                <p>AIæ­£åœ¨ä¸ºä½ ç”Ÿæˆä¸ªæ€§åŒ–è¡Œä¸ºæ–¹æ¡ˆ...</p>
                <p style="font-size: 0.9em; color: #718096; margin-top: 10px;">
                    è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´
                </p>
            </div>
        </div>
    </div>

    <!-- æµ®åŠ¨æ§ä»¶ -->
    <div class="floating-controls" id="floatingControls">
        <div class="floating-count" id="floatingCount">å·²é€‰æ‹©ï¼š0 / 10ä¸ª</div>
        <div class="floating-progress">
            <div class="floating-progress-fill" id="floatingProgressFill" style="width: 0%"></div>
        </div>
        <button class="floating-btn" id="floatingNextBtn" disabled onclick="proceedToNext()">
            è¿›å…¥ä¸‹ä¸€æ­¥
        </button>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let userWish = '';
        let allBehaviors = [];
        let selectedWillingBehaviors = [];
        let selectedAbleBehaviors = [];
        let finalRecipes = [];
        let currentBehaviorPage = 0;
        const behaviorsPerPage = 10;



        // æ˜¾ç¤ºåŠ è½½é¡µé¢
        function showLoading() {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('loading-page').classList.add('active');
        }

        // æ¨¡æ‹Ÿä¸AI APIçš„äº¤äº’ï¼ˆå®é™…ä½¿ç”¨æ—¶éœ€è¦è¿æ¥çœŸå®APIï¼‰
        async function callAIAPI(prompt, type = 'behaviors') {
            // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 2000));

            // å¦‚æœé…ç½®æ–‡ä»¶ä¸­çš„APIå‡½æ•°å¯ç”¨ï¼Œä½¿ç”¨å®ƒ
            if (typeof CONFIG !== 'undefined' && typeof getBackupData === 'function') {
                return getBackupData(type, prompt);
            }

            // å¦åˆ™ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿå‡½æ•°
            if (type === 'behaviors') {
                return generateMockBehaviors(prompt);
            } else if (type === 'anchors') {
                return generateMockAnchors();
            } else if (type === 'celebrations') {
                return generateMockCelebrations();
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿè¡Œä¸ºæ•°æ®
        function generateMockBehaviors(wish) {
            const behaviorTemplates = [
                "æ¯å¤©æ—©ä¸Šèµ·åºŠåç«‹å³å–ä¸€æ¯æ¸©æ°´",
                "æ¯æ¬¡ä½¿ç”¨æ‰‹æœºå‰å…ˆæ·±å‘¼å¸3æ¬¡",
                "æ¯å¤©æ™šä¸Šç¡å‰å†™ä¸‹3ä»¶æ„Ÿæ©çš„äº‹æƒ…",
                "æ¯æ¬¡åä¸‹å·¥ä½œå‰æ•´ç†ä¸€ä¸‹æ¡Œé¢",
                "æ¯å¤©ä¸­åˆåƒé¥­å‰åš2åˆ†é’Ÿæ‹‰ä¼¸",
                "æ¯æ¬¡æ´—æ‰‹åç…§é•œå­å¯¹è‡ªå·±å¾®ç¬‘",
                "æ¯å¤©ç¡å‰è¯»ä¹¦5åˆ†é’Ÿ",
                "æ¯æ¬¡è¿›é—¨åç«‹å³æ¢æ‹–é‹",
                "æ¯å¤©æ—©ä¸Šå‡ºé—¨å‰æ£€æŸ¥å¤©æ°”",
                "æ¯æ¬¡åƒå®Œé¥­åç«‹å³åˆ·ç‰™",
                "æ¯å¤©æ™šä¸Š10ç‚¹åå…³é—­æ‰€æœ‰ç”µå­è®¾å¤‡",
                "æ¯æ¬¡æ„Ÿåˆ°å‹åŠ›æ—¶åš5æ¬¡æ·±å‘¼å¸",
                "æ¯å¤©æ—©ä¸Šèµ·åºŠååš5ä¸ªä¿¯å§æ’‘",
                "æ¯æ¬¡å¼€ä¼šå‰å‡†å¤‡ä¸€æ¯èŒ¶",
                "æ¯å¤©æ™šä¸Šæ´—è„¸åæ¶‚æŠ¤è‚¤å“",
                "æ¯æ¬¡åç”µæ¢¯æ—¶ç»ƒä¹ æ­£ç¡®ç«™å§¿",
                "æ¯å¤©ç¡å‰æ•´ç†æ˜å¤©çš„è¡£æœ",
                "æ¯æ¬¡é¥­åæ•£æ­¥10åˆ†é’Ÿ",
                "æ¯å¤©æ—©ä¸Šèµ·åºŠåå¼€çª—é€šé£",
                "æ¯æ¬¡å·¥ä½œä¼‘æ¯æ—¶çœºæœ›è¿œæ–¹30ç§’",
                "æ¯å¤©æ™šä¸Šç¡å‰å…³é—­æˆ¿é—´æ‰€æœ‰ç¯å…‰",
                "æ¯æ¬¡è´­ç‰©å‰åˆ—ä¸€ä¸ªæ¸…å•",
                "æ¯å¤©èµ·åºŠåç«‹å³é“ºåºŠ",
                "æ¯æ¬¡æ´—æ¾¡åç§°ä½“é‡",
                "æ¯å¤©ä¸­åˆä¼‘æ¯æ—¶å¬5åˆ†é’Ÿè½»éŸ³ä¹",
                "æ¯æ¬¡ä½¿ç”¨ç”µè„‘å‰è°ƒæ•´åå§¿",
                "æ¯å¤©æ™šä¸Šç¡å‰æ”¾ä¸‹æ‰‹æœº",
                "æ¯æ¬¡ç­‰ç”µæ¢¯æ—¶åšè„šè¸è¿åŠ¨",
                "æ¯å¤©æ—©ä¸Šèµ·åºŠåæ‹‰å¼€çª—å¸˜",
                "æ¯æ¬¡åƒé¥­å‰è¯´ä¸€å¥æ„Ÿè°¢",
            ];

            // éšæœºé€‰æ‹©å’Œæ‰“ä¹±é¡ºåº
            return behaviorTemplates.sort(() => Math.random() - 0.5);
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿé”šç‚¹æ•°æ®
        function generateMockAnchors() {
            return [
                "åœ¨æˆ‘èµ·åºŠä¸‹åºŠä¹‹å",
                "åœ¨æˆ‘åˆ·å®Œç‰™ä¹‹å",
                "åœ¨æˆ‘æ´—å®Œè„¸ä¹‹å",
                "åœ¨æˆ‘ç©¿å¥½è¡£æœä¹‹å",
                "åœ¨æˆ‘åƒå®Œæ—©é¤ä¹‹å",
                "åœ¨æˆ‘ååˆ°åŠå…¬æ¡Œå‰ä¹‹å",
                "åœ¨æˆ‘æ‰“å¼€ç”µè„‘ä¹‹å",
                "åœ¨æˆ‘åƒå®Œåˆé¤ä¹‹å",
                "åœ¨æˆ‘ä¸‹ç­å›å®¶ä¹‹å",
                "åœ¨æˆ‘æ”¾ä¸‹åŒ…ä¹‹å",
                "åœ¨æˆ‘æ¢å¥½æ‹–é‹ä¹‹å",
                "åœ¨æˆ‘æ´—å®Œæ¾¡ä¹‹å",
                "åœ¨æˆ‘èººåˆ°åºŠä¸Šä¹‹å",
                "åœ¨æˆ‘å…³ç¯ä¹‹å",
                "åœ¨æˆ‘å–å®Œæ°´ä¹‹å",
                "åœ¨æˆ‘ä¸Šå®Œå•æ‰€ä¹‹å",
                "åœ¨æˆ‘é”å¥½é—¨ä¹‹å",
                "åœ¨æˆ‘åä¸‹æ¥ä¹‹å",
                "åœ¨æˆ‘ç«™èµ·æ¥ä¹‹å",
                "åœ¨æˆ‘æ¥å®Œç”µè¯ä¹‹å"
            ];
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿåº†ç¥æ•°æ®
        function generateMockCelebrations() {
            return [
                "åœ¨å¿ƒé‡Œè¯´'å¤ªæ£’äº†ï¼'",
                "å¾®ç¬‘å¹¶ç‚¹å¤´",
                "æ¡æ‹³åšèƒœåˆ©æ‰‹åŠ¿",
                "æ·±å‘¼å¸ä¸€æ¬¡",
                "ç»™è‡ªå·±ç‚¹ä¸ªèµ",
                "åœ¨å¿ƒé‡Œè¯´'æˆ‘åšåˆ°äº†ï¼'",
                "è½»è½»æ‹æ‹è‡ªå·±çš„è‚©è†€",
                "é—­çœ¼æ„Ÿå—æˆå°±æ„Ÿ3ç§’",
                "åœ¨å¿ƒé‡Œå“¼ä¸€é¦–å–œæ¬¢çš„æ­Œ",
                "æƒ³è±¡æœ‹å‹ä¸ºæˆ‘é¼“æŒ",
                "åšä¸€ä¸ªå¼€å¿ƒçš„è¡¨æƒ…",
                "åœ¨å¿ƒé‡Œè¯´'åˆè¿›æ­¥äº†ä¸€ç‚¹ï¼'",
                "è½»è½»è·³ä¸€ä¸‹",
                "åšä¸€ä¸ª'V'å­—æ‰‹åŠ¿",
                "åœ¨å¿ƒé‡Œè¯´'æˆ‘å¾ˆæ£’ï¼'",
                "æƒ³è±¡çœ‹åˆ°çƒŸèŠ±ç»½æ”¾",
                "æ‰“ä¸ªå“æŒ‡",
                "åœ¨å¿ƒé‡Œè¯´'ç»§ç»­ä¿æŒï¼'",
                "åšä¸€ä¸ªå¾—æ„çš„ç¬‘å®¹",
                "åœ¨å¿ƒé‡Œè¯´'æˆ‘å€¼å¾—ä¸ºæ­¤éª„å‚²ï¼'"
            ];
        }

        // å¼€å§‹ç”Ÿæˆè¡Œä¸ºæ–¹æ¡ˆ
        async function startBehaviorGeneration() {
            const wishInput = document.getElementById('wishInput').value.trim();

            if (!wishInput) {
                alert('è¯·è¾“å…¥ä½ çš„æ„¿æœ›ï¼');
                return;
            }

            if (wishInput.length < 10) {
                alert('æ„¿æœ›æè¿°å¤ªç®€å•äº†ï¼Œè¯·è¯¦ç»†æè¿°ä¸€ä¸‹ä½ æƒ³è¦å®ç°çš„æ„¿æœ›ã€‚');
                return;
            }

            userWish = wishInput;
            showLoading();

            try {
                // è°ƒç”¨AIç”Ÿæˆè¡Œä¸ºæ–¹æ¡ˆ
                allBehaviors = await callAIAPI(userWish, 'behaviors');
                currentBehaviorPage = 0;
                selectedWillingBehaviors = [];

                // æ˜¾ç¤ºè¡Œä¸ºé€‰æ‹©é¡µé¢
                displayBehaviors();
                // åœ¨ç¬¬äºŒé¡µæ˜¾ç¤ºç”¨æˆ·æ„¿æœ›
                document.getElementById('currentWish').textContent = userWish;
                goToPage(2);
            } catch (error) {
                console.error('ç”Ÿæˆè¡Œä¸ºæ–¹æ¡ˆå¤±è´¥:', error);
                alert('ç”Ÿæˆæ–¹æ¡ˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                goToPage(1);
            }
        }

        // æ˜¾ç¤ºè¡Œä¸ºé€‰æ‹©
        function displayBehaviors() {
            const container = document.getElementById('behaviorsContainer');
            const startIndex = currentBehaviorPage * behaviorsPerPage;
            const endIndex = startIndex + behaviorsPerPage;
            const behaviorsBatch = allBehaviors.slice(startIndex, endIndex);

            if (currentBehaviorPage === 0) {
                container.innerHTML = '';
            }

            behaviorsBatch.forEach((behavior, index) => {
                const behaviorDiv = document.createElement('div');
                behaviorDiv.className = 'behavior-item';
                behaviorDiv.innerHTML = `
                <div class="behavior-header">
                    <span class="behavior-tag">ğŸ¯ ä¸ºä½ çš„æ„¿æœ›å®šåˆ¶</span>
                </div>
                <div class="behavior-text">${behavior}</div>
                <div class="behavior-buttons">
                    <button class="checkbox-btn" onclick="toggleWillingBehavior(${startIndex + index}, this)">
                        æˆ‘æ„¿æ„åš
                    </button>
                </div>
            `;
                container.appendChild(behaviorDiv);
            });

            updateWillingCount();
        }

        // åˆ‡æ¢æ„¿æ„åšçš„è¡Œä¸º
        function toggleWillingBehavior(index, button) {
            const behavior = allBehaviors[index];
            const behaviorItem = button.closest('.behavior-item');

            if (selectedWillingBehaviors.includes(behavior)) {
                selectedWillingBehaviors = selectedWillingBehaviors.filter(b => b !== behavior);
                button.classList.remove('selected');
                behaviorItem.classList.remove('selected');
            } else {
                selectedWillingBehaviors.push(behavior);
                button.classList.add('selected');
                behaviorItem.classList.add('selected');
            }

            updateWillingCount();
        }

        // æ›´æ–°æ„¿æ„åšçš„è¡Œä¸ºè®¡æ•°
        function updateWillingCount() {
            const count = selectedWillingBehaviors.length;
            document.getElementById('willingCount').textContent = count;

            const progress = Math.min(count / 10 * 100, 100);
            document.getElementById('progressFill1').style.width = progress + '%';

            const proceedBtn = document.getElementById('proceedBtn1');
            if (count >= 10) {
                proceedBtn.disabled = false;
            } else {
                proceedBtn.disabled = true;
            }

            // æ›´æ–°æµ®åŠ¨æ§ä»¶
            updateFloatingControls('willing', count, progress, count >= 10);
        }

        // åŠ è½½æ›´å¤šè¡Œä¸ºé€‰é¡¹
        function loadMoreBehaviors() {
            if ((currentBehaviorPage + 1) * behaviorsPerPage < allBehaviors.length) {
                currentBehaviorPage++;
                displayBehaviors();
            } else {
                alert('å·²æ˜¾ç¤ºæ‰€æœ‰è¡Œä¸ºé€‰é¡¹');
            }
        }

        // è¿›å…¥èƒ½åŠ›ç­›é€‰é˜¶æ®µ
        function proceedToAbility() {
            if (selectedWillingBehaviors.length < 10) {
                alert('è¯·è‡³å°‘é€‰æ‹©10ä¸ªä½ æ„¿æ„åšçš„è¡Œä¸º');
                return;
            }

            displayAbilitySelection();
            goToPage(3);
        }

        // æ˜¾ç¤ºèƒ½åŠ›ç­›é€‰
        function displayAbilitySelection() {
            const container = document.getElementById('abilityContainer');
            container.innerHTML = '';

            selectedWillingBehaviors.forEach((behavior, index) => {
                const behaviorDiv = document.createElement('div');
                behaviorDiv.className = 'behavior-item';
                behaviorDiv.innerHTML = `
                    <div class="behavior-header">
                        <span class="behavior-tag">âœ… ä½ æ„¿æ„åšçš„è¡Œä¸º</span>
                    </div>
                    <div class="behavior-text">${behavior}</div>
                    <div class="behavior-buttons">
                        <button class="checkbox-btn" onclick="toggleAbleBehavior(${index}, this)">
                            æˆ‘èƒ½åšåˆ°
                        </button>
                    </div>
                `;
                container.appendChild(behaviorDiv);
            });

            selectedAbleBehaviors = [];
            updateAbleCount();
        }

        // åˆ‡æ¢èƒ½åšåˆ°çš„è¡Œä¸º
        function toggleAbleBehavior(index, button) {
            const behavior = selectedWillingBehaviors[index];
            const behaviorItem = button.closest('.behavior-item');

            if (selectedAbleBehaviors.includes(behavior)) {
                selectedAbleBehaviors = selectedAbleBehaviors.filter(b => b !== behavior);
                button.classList.remove('selected');
                behaviorItem.classList.remove('selected');
            } else {
                selectedAbleBehaviors.push(behavior);
                button.classList.add('selected');
                behaviorItem.classList.add('selected');
            }

            updateAbleCount();
        }

        // æ›´æ–°èƒ½åšåˆ°çš„è¡Œä¸ºè®¡æ•°
        function updateAbleCount() {
            const count = selectedAbleBehaviors.length;
            document.getElementById('ableCount').textContent = count;

            const progress = count / selectedWillingBehaviors.length * 100;
            document.getElementById('progressFill2').style.width = progress + '%';

            const proceedBtn = document.getElementById('proceedBtn2');
            if (count > 0) {
                proceedBtn.disabled = false;
            } else {
                proceedBtn.disabled = true;
            }

            // æ›´æ–°æµ®åŠ¨æ§ä»¶
            updateFloatingControls('able', count, progress, count > 0);
        }

        // è¿›å…¥é…æ–¹ç”Ÿæˆé˜¶æ®µ
        async function proceedToRecipe() {
            if (selectedAbleBehaviors.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä½ èƒ½åšåˆ°çš„è¡Œä¸º');
                return;
            }

            showLoading();

            try {
                // ç”Ÿæˆé”šç‚¹å’Œåº†ç¥é€‰é¡¹
                const anchors = await callAIAPI('', 'anchors');
                const celebrations = await callAIAPI('', 'celebrations');

                await displayRecipeGeneration(anchors, celebrations);
                goToPage(4);
            } catch (error) {
                console.error('ç”Ÿæˆé…æ–¹å¤±è´¥:', error);
                alert('ç”Ÿæˆé…æ–¹å¤±è´¥ï¼Œè¯·é‡è¯•');
                goToPage(3);
            }
        }

        // æ˜¾ç¤ºé…æ–¹ç”Ÿæˆ
        async function displayRecipeGeneration(anchors, celebrations) {
            const container = document.getElementById('recipeContainer');
            container.innerHTML = '';

            finalRecipes = [];

            for (let i = 0; i < selectedAbleBehaviors.length; i++) {
                const behavior = selectedAbleBehaviors[i];
                const recipeDiv = document.createElement('div');
                recipeDiv.className = 'final-recipe';
                recipeDiv.innerHTML = `
                    <h3>é»„é‡‘è¡Œä¸º ${i + 1}ï¼š${behavior}</h3>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">é€‰æ‹©é”šç‚¹ï¼ˆåœ¨...ä¹‹åï¼‰ï¼š</label>
                        <div class="options-container" id="anchors-${i}">
                            ${getInitialAnchors(behavior, anchors).map((anchor, j) => `
                                <div class="anchor-option" onclick="selectAnchor(${i}, ${j}, '${anchor}')">
                                    ${anchor}
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-small" onclick="refreshAnchors(${i})">æ›´æ¢é”šç‚¹é€‰é¡¹</button>
                    </div>

                    <div style="margin: 15px 0;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">é€‰æ‹©åº†ç¥æ–¹å¼ï¼ˆæˆ‘ä¼š...ï¼‰ï¼š</label>
                        <div class="options-container" id="celebrations-${i}">
                            ${getInitialCelebrations(behavior, celebrations).map((celebration, j) => `
                                <div class="celebration-option" onclick="selectCelebration(${i}, ${j}, '${celebration}')">
                                    ${celebration}
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-small" onclick="refreshCelebrations(${i})">æ›´æ¢åº†ç¥é€‰é¡¹</button>
                    </div>

                    <div class="recipe-formula" id="formula-${i}">
                        <strong>é…æ–¹ï¼š</strong><span id="recipe-text-${i}">è¯·é€‰æ‹©é”šç‚¹å’Œåº†ç¥æ–¹å¼</span>
                    </div>
                `;
                container.appendChild(recipeDiv);

                // åˆå§‹åŒ–é…æ–¹å¯¹è±¡
                finalRecipes.push({
                    behavior: behavior,
                    anchor: '',
                    celebration: ''
                });
            }

            // å­˜å‚¨é”šç‚¹å’Œåº†ç¥é€‰é¡¹ä»¥å¤‡åˆ·æ–°ä½¿ç”¨
            window.currentAnchors = anchors;
            window.currentCelebrations = celebrations;
        }

        // é€‰æ‹©é”šç‚¹
        function selectAnchor(recipeIndex, anchorIndex, anchor) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll(`#anchors-${recipeIndex} .anchor-option`).forEach(el => {
                el.classList.remove('selected');
            });

            // é€‰æ‹©æ–°çš„é”šç‚¹
            document.querySelector(`#anchors-${recipeIndex} .anchor-option:nth-child(${anchorIndex + 1})`).classList.add('selected');

            finalRecipes[recipeIndex].anchor = anchor;
            updateRecipeFormula(recipeIndex);
        }

        // é€‰æ‹©åº†ç¥æ–¹å¼
        function selectCelebration(recipeIndex, celebrationIndex, celebration) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll(`#celebrations-${recipeIndex} .celebration-option`).forEach(el => {
                el.classList.remove('selected');
            });

            // é€‰æ‹©æ–°çš„åº†ç¥æ–¹å¼
            document.querySelector(`#celebrations-${recipeIndex} .celebration-option:nth-child(${celebrationIndex + 1})`).classList.add('selected');

            finalRecipes[recipeIndex].celebration = celebration;
            updateRecipeFormula(recipeIndex);
        }

        // æ›´æ–°é…æ–¹å…¬å¼
        function updateRecipeFormula(recipeIndex) {
            const recipe = finalRecipes[recipeIndex];
            const formulaEl = document.getElementById(`recipe-text-${recipeIndex}`);

            if (recipe.anchor && recipe.celebration) {
                formulaEl.innerHTML = `${recipe.anchor}ï¼Œæˆ‘ä¼š<strong>${recipe.behavior}</strong>ï¼Œä¸ºäº†è®©å¤§è„‘ç‰¢è®°è¿™ä¸ªä¹ æƒ¯ï¼Œæˆ‘ä¼š<strong>${recipe.celebration}</strong>ã€‚`;
            } else if (recipe.anchor) {
                formulaEl.innerHTML = `${recipe.anchor}ï¼Œæˆ‘ä¼š<strong>${recipe.behavior}</strong>ï¼Œä¸ºäº†è®©å¤§è„‘ç‰¢è®°è¿™ä¸ªä¹ æƒ¯ï¼Œæˆ‘ä¼š<strong>[è¯·é€‰æ‹©åº†ç¥æ–¹å¼]</strong>ã€‚`;
            } else if (recipe.celebration) {
                formulaEl.innerHTML = `<strong>[è¯·é€‰æ‹©é”šç‚¹]</strong>ï¼Œæˆ‘ä¼š<strong>${recipe.behavior}</strong>ï¼Œä¸ºäº†è®©å¤§è„‘ç‰¢è®°è¿™ä¸ªä¹ æƒ¯ï¼Œæˆ‘ä¼š<strong>${recipe.celebration}</strong>ã€‚`;
            }
        }

        // åˆ·æ–°é”šç‚¹é€‰é¡¹
        async function refreshAnchors(recipeIndex) {
            try {
                // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const container = document.getElementById(`anchors-${recipeIndex}`);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">æ­£åœ¨ç”Ÿæˆæ–°çš„é”šç‚¹é€‰é¡¹...</div>';

                // è·å–é»„é‡‘è¡Œä¸ºç”¨äºç”Ÿæˆé’ˆå¯¹æ€§é”šç‚¹
                const currentBehavior = finalRecipes[recipeIndex].behavior;
                const anchors = await callAIAPI(currentBehavior, 'anchors');

                // ä½¿ç”¨æ™ºèƒ½åŒ¹é…è·å–é’ˆå¯¹æ€§é”šç‚¹
                let availableAnchors;
                if (typeof getBackupDataSmart === 'function') {
                    availableAnchors = getBackupDataSmart('anchors', '', currentBehavior);
                } else {
                    availableAnchors = anchors;
                }

                // éšæœºæ‰“ä¹±å¹¶é€‰æ‹©5ä¸ª
                const shuffled = availableAnchors.sort(() => 0.5 - Math.random());
                const selectedAnchors = shuffled.slice(0, 5);

                container.innerHTML = selectedAnchors.map((anchor, j) => `
                    <div class="anchor-option" onclick="selectAnchor(${recipeIndex}, ${j}, '${anchor}')">
                        ${anchor}
                    </div>
                `).join('');
            } catch (error) {
                console.error('åˆ·æ–°é”šç‚¹å¤±è´¥:', error);
                // ä½¿ç”¨å¤‡ç”¨é”šç‚¹
                const backupAnchors = [
                    "åœ¨æˆ‘èµ·åºŠä¸‹åºŠä¹‹å", "åœ¨æˆ‘åˆ·å®Œç‰™ä¹‹å", "åœ¨æˆ‘æ´—å®Œè„¸ä¹‹å",
                    "åœ¨æˆ‘åƒå®Œæ—©é¤ä¹‹å", "åœ¨æˆ‘æ‰“å¼€ç”µè„‘ä¹‹å"
                ];
                const container = document.getElementById(`anchors-${recipeIndex}`);
                container.innerHTML = backupAnchors.map((anchor, j) => `
                    <div class="anchor-option" onclick="selectAnchor(${recipeIndex}, ${j}, '${anchor}')">
                        ${anchor}
                    </div>
                `).join('');
            }
        }

        // åˆ·æ–°åº†ç¥é€‰é¡¹
        async function refreshCelebrations(recipeIndex) {
            try {
                // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const container = document.getElementById(`celebrations-${recipeIndex}`);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">æ­£åœ¨ç”Ÿæˆæ–°çš„åº†ç¥é€‰é¡¹...</div>';

                // è·å–é»„é‡‘è¡Œä¸ºç”¨äºç”Ÿæˆé’ˆå¯¹æ€§åº†ç¥
                const currentBehavior = finalRecipes[recipeIndex].behavior;
                const celebrations = await callAIAPI(currentBehavior, 'celebrations');

                // ä½¿ç”¨æ™ºèƒ½åŒ¹é…è·å–é’ˆå¯¹æ€§åº†ç¥æ–¹å¼
                let availableCelebrations;
                if (typeof getBackupDataSmart === 'function') {
                    availableCelebrations = getBackupDataSmart('celebrations', '', currentBehavior);
                } else {
                    availableCelebrations = celebrations;
                }

                // éšæœºæ‰“ä¹±å¹¶é€‰æ‹©5ä¸ª
                const shuffled = availableCelebrations.sort(() => 0.5 - Math.random());
                const selectedCelebrations = shuffled.slice(0, 5);

                container.innerHTML = selectedCelebrations.map((celebration, j) => `
                    <div class="celebration-option" onclick="selectCelebration(${recipeIndex}, ${j}, '${celebration}')">
                        ${celebration}
                    </div>
                `).join('');
            } catch (error) {
                console.error('åˆ·æ–°åº†ç¥æ–¹å¼å¤±è´¥:', error);
                // ä½¿ç”¨å¤‡ç”¨åº†ç¥æ–¹å¼
                const backupCelebrations = [
                    "åœ¨å¿ƒé‡Œè¯´'å¤ªæ£’äº†ï¼'", "å¾®ç¬‘å¹¶ç‚¹å¤´", "æ¡æ‹³åšèƒœåˆ©æ‰‹åŠ¿",
                    "æ·±å‘¼å¸ä¸€æ¬¡", "ç»™è‡ªå·±ç‚¹ä¸ªèµ"
                ];
                const container = document.getElementById(`celebrations-${recipeIndex}`);
                container.innerHTML = backupCelebrations.map((celebration, j) => `
                    <div class="celebration-option" onclick="selectCelebration(${recipeIndex}, ${j}, '${celebration}')">
                        ${celebration}
                    </div>
                `).join('');
            }
        }

        // è¿›å…¥æœ€ç»ˆç»“æœé¡µé¢
        function proceedToFinal() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é…æ–¹éƒ½å·²å®Œæˆ
            const incompleteRecipes = finalRecipes.filter(recipe => !recipe.anchor || !recipe.celebration);
            if (incompleteRecipes.length > 0) {
                alert(`è¿˜æœ‰ ${incompleteRecipes.length} ä¸ªé…æ–¹æœªå®Œæˆï¼Œè¯·ä¸ºæ‰€æœ‰é»„é‡‘è¡Œä¸ºé€‰æ‹©é”šç‚¹å’Œåº†ç¥æ–¹å¼`);
                return;
            }

            displayFinalResults();
            goToPage(5);
        }

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        function displayFinalResults() {
            document.getElementById('finalWish').textContent = userWish;
            const container = document.getElementById('finalRecipeContainer');

            container.innerHTML = finalRecipes.map((recipe, index) => `
                <div class="final-recipe">
                    <h3>ğŸ’ é»„é‡‘è¡Œä¸º ${index + 1}</h3>
                    <div class="recipe-formula">
                        ${recipe.anchor}ï¼Œæˆ‘ä¼š<strong>${recipe.behavior}</strong>ï¼Œä¸ºäº†è®©å¤§è„‘ç‰¢è®°è¿™ä¸ªä¹ æƒ¯ï¼Œæˆ‘ä¼š<strong>${recipe.celebration}</strong>ã€‚
                    </div>
                </div>
            `).join('');
        }

        // æµ®åŠ¨æ§ä»¶ç®¡ç†
        function updateFloatingControls(type, count, progress, canProceed) {
            const floatingControls = document.getElementById('floatingControls');
            const floatingCount = document.getElementById('floatingCount');
            const floatingProgressFill = document.getElementById('floatingProgressFill');
            const floatingNextBtn = document.getElementById('floatingNextBtn');

            if (currentPage === 2 || currentPage === 3) {
                floatingControls.classList.add('show');

                if (type === 'willing') {
                    floatingCount.textContent = `å·²é€‰æ‹©ï¼š${count} / 10ä¸ªï¼ˆæœ€å°‘ï¼‰`;
                    floatingNextBtn.textContent = 'è¿›å…¥èƒ½åŠ›ç­›é€‰';
                } else if (type === 'able') {
                    floatingCount.textContent = `å·²é€‰æ‹©ï¼š${count} ä¸ªé»„é‡‘è¡Œä¸º`;
                    floatingNextBtn.textContent = 'ç”Ÿæˆä¹ æƒ¯é…æ–¹';
                }

                floatingProgressFill.style.width = progress + '%';
                floatingNextBtn.disabled = !canProceed;
            } else {
                floatingControls.classList.remove('show');
            }
        }

        // æµ®åŠ¨æŒ‰é’®çš„ä¸‹ä¸€æ­¥å‡½æ•°
        function proceedToNext() {
            if (currentPage === 2) {
                proceedToAbility();
            } else if (currentPage === 3) {
                proceedToRecipe();
            }
        }

        // æ›´æ–°é¡µé¢å¯¼èˆªå‡½æ•°
        function goToPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page-${pageNumber}`).classList.add('active');
            currentPage = pageNumber;

            // æ§åˆ¶æµ®åŠ¨æ§ä»¶æ˜¾ç¤º
            if (pageNumber === 2 && selectedWillingBehaviors.length > 0) {
                updateFloatingControls('willing', selectedWillingBehaviors.length,
                    Math.min(selectedWillingBehaviors.length / 10 * 100, 100),
                    selectedWillingBehaviors.length >= 10);
            } else if (pageNumber === 3 && selectedAbleBehaviors.length > 0) {
                updateFloatingControls('able', selectedAbleBehaviors.length,
                    selectedAbleBehaviors.length / selectedWillingBehaviors.length * 100,
                    selectedAbleBehaviors.length > 0);
            } else {
                document.getElementById('floatingControls').classList.remove('show');
            }
        }

        // è·å–åˆå§‹é”šç‚¹ï¼ˆæ™ºèƒ½åŒ¹é…ï¼‰
        function getInitialAnchors(behavior, defaultAnchors) {
            if (typeof getBackupDataSmart === 'function') {
                const smartAnchors = getBackupDataSmart('anchors', '', behavior);
                return smartAnchors.slice(0, 5);
            } else {
                return defaultAnchors.slice(0, 5);
            }
        }

        // è·å–åˆå§‹åº†ç¥æ–¹å¼ï¼ˆæ™ºèƒ½åŒ¹é…ï¼‰
        function getInitialCelebrations(behavior, defaultCelebrations) {
            if (typeof getBackupDataSmart === 'function') {
                const smartCelebrations = getBackupDataSmart('celebrations', '', behavior);
                return smartCelebrations.slice(0, 5);
            } else {
                return defaultCelebrations.slice(0, 5);
            }
        }

        // é‡æ–°å¼€å§‹æµç¨‹
        function restartProcess() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰çš„é…æ–¹å°†ä¼šä¸¢å¤±ã€‚')) {
                // é‡ç½®æ‰€æœ‰æ•°æ®
                userWish = '';
                allBehaviors = [];
                selectedWillingBehaviors = [];
                selectedAbleBehaviors = [];
                finalRecipes = [];
                currentBehaviorPage = 0;

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('wishInput').value = '';

                // é‡ç½®è®¡æ•°å™¨
                document.getElementById('willingCount').textContent = '0';
                document.getElementById('ableCount').textContent = '0';

                // é‡ç½®è¿›åº¦æ¡
                document.getElementById('progressFill1').style.width = '0%';
                document.getElementById('progressFill2').style.width = '0%';

                // éšè—æµ®åŠ¨æ§ä»¶
                document.getElementById('floatingControls').classList.remove('show');

                // å›åˆ°ç¬¬ä¸€é¡µ
                goToPage(1);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒAPIè°ƒç”¨
            console.log('AIå¾®ä¹ æƒ¯å·¥å…·ç®±å·²åŠ è½½');

            // æ·»åŠ è¾“å…¥éªŒè¯
            document.getElementById('wishInput').addEventListener('input', function (e) {
                const value = e.target.value;
                if (value.length > 200) {
                    e.target.value = value.substring(0, 200);
                }
            });
        });
    </script>

    <!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
    <script src="config.js"></script>
</body>

</html>